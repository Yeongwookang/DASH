<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="approval">
	<sql id="where-list">
		<if test="condition=='dep'">
			INSTR(depName, #{keyword}) &gt;= 1
		</if>
		<if test="condition=='pos'">
			INSTR(posName, #{keyword}) &gt;= 1
		</if>
		<if test="condition=='name'">
			INSTR(name, #{keyword}) &gt;= 1
		</if>
		<if test="condition=='rank'">
			INSTR(rankName, #{keyword}) &gt;= 1
		</if>
		<if test="condition=='team'">
			INSTR(teamName, #{keyword}) &gt;= 1
		</if>
	</sql>
	
	<select id="empList" parameterType="map" resultType="com.sp.app.employee.Employee">
		SELECT e.EMPNO, name, state, reg_date, depName, posName, rankName, teamName FROM PERSON_RECORD pr 
		LEFT OUTER JOIN employee e ON pr.empNo= e.empNo
		LEFT OUTER JOIN DEPARTMENT d ON d.DEPNO = pr.DEPNO
		LEFT OUTER JOIN POSITION p ON p.POSNO = pr.POSNO
		LEFT OUTER JOIN team t ON t.teamNo = pr.teamNo
		LEFT OUTER JOIN rank r on r.rankNo = pr.rankNo
		<where>
			state = 1
			<if test="keyword != null and keyword != '' ">
				AND <include refid="where-list"/>
			</if>
		</where> 
	</select>

	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0) FROM PERSON_RECORD pr 
		LEFT OUTER JOIN employee e ON pr.empNo=e.empNo
		LEFT OUTER JOIN DEPARTMENT d ON d.DEPNO = pr.DEPNO
		LEFT OUTER JOIN POSITION p ON p.POSNO = pr.POSNO
		<where>
			state = 1 
			<if test="keyword !=null and keyword !=''">
				AND	<include refid="where-list"/>
			</if>
		</where>
	</select>
	
	<update id ="insertApproval" parameterType="map" >
		INSERT ALL 
			INTO e_document (signNum, title, content, empNo, formnum) 
			VALUES (LPAD(e_document_SEQ.NEXTVAL,8,'0'), #{title}, #{content}, #{empNo}, 1)
			INTO doc_record (signNum, reg_date, state) VALUES(e_document_SEQ.CURRVAL, sysdate, '기안')
			
			<if test="ref1 !=null">
				INTO f_approval (signNum, state, empNo) 
				VALUES (LPAD(e_document_SEQ.CURRVAL, 8, '0'), '대기', #{ref1})
			</if>
			
			<if test="ref2 !=null">
				INTO s_approval (signNum, state, empNo)
				VALUES (LPAD(e_document_SEQ.CURRVAL, 8, '0'), '대기', #{ref2})
			</if>
			
			<if test="ref3 !=null">
				INTO t_approval (signNum, state, empNo)
				VALUES (LPAD(e_document_SEQ.CURRVAL, 8, '0'), '대기', #{ref3})
			</if>
			
		SELECT * FROM dual
	</update>
	
	
	<select id="approvalList" parameterType="map" resultType="approval">
		SELECT title, rankName, teamName, depName, posName, emp.name, dr.state, e.signNum  From e_document e 
		LEFT OUTER JOIN doc_record dr ON dr.signNum = e.signNum
		LEFT OUTER JOIN f_approval f ON e.signNum = f.signNum
		LEFT OUTER JOIN s_approval s ON e.signNum = s.signNum
		LEFT OUTER JOIN t_approval t ON e.signNum = t.signNum
		LEFT OUTER JOIN employee emp ON emp.empNo = e.empNo
		LEFT OUTER JOIN PERSON_RECORD pr ON pr.empNo = e.empNO AND pr.state=1
		LEFT OUTER JOIN position pos ON pos.posNo = pr.posNo
		LEFT OUTER JOIN rank ON rank.rankNo = pr.rankNo
		LEFT OUTER JOIN department dep ON dep.depNo = pr.depNo
		LEFT OUTER JOIN team ON team.teamNo = pr.posNo
		WHERE e.empNo = #{empNo} 
		OR (f.empNo = #{empNo} AND f.state='대기')
		OR (s.empNo = #{empNo} AND s.state='대기')
		OR (t.empNo = #{empNo} AND t.state='대기')
	</select>
	
	<select id="myApprovalList" parameterType="map" resultType="approval">
		SELECT e.title, depName, emp.name, dr.state, to_char(dr.reg_date,'YYYY-MM-DD')reg_date, e.signNum  FROM doc_record dr
		LEFT OUTER JOIN e_document e ON e.signNum = dr.signNum
		LEFT OUTER JOIN employee emp ON emp.empNo = e.empNo
		LEFT OUTER JOIN PERSON_RECORD pr ON pr.empNo = e.empNO AND pr.state=1
		LEFT OUTER JOIN position pos ON pos.posNo = pr.posNo
		LEFT OUTER JOIN rank ON rank.rankNo = pr.rankNo
		LEFT OUTER JOIN department dep ON dep.depNo = pr.depNo
		LEFT OUTER JOIN team ON team.teamNo = pr.posNo
		WHERE emp.empNo = #{empNo}
	</select>
	
	<select id="readApproval" parameterType="Long" resultType="approval">
		SELECT title, content, e.signNum, emp.empNo, depName, emp.name FROM e_document e
		LEFT OUTER JOIN f_approval f ON e.signNum = f.signNum
		LEFT OUTER JOIN s_approval s ON e.signNum = s.signNum
		LEFT OUTER JOIN t_approval t ON e.signNum = t.signNum
		LEFT OUTER JOIN employee emp ON emp.empNo = e.empNo
		LEFT OUTER JOIN PERSON_RECORD pr ON pr.empNo = e.empNO AND pr.state=1
		LEFT OUTER JOIN rank ON rank.rankNo = pr.rankNo
		LEFT OUTER JOIN department dep ON dep.depNo = pr.depNo
		LEFT OUTER JOIN team ON team.teamNo = pr.posNo
		WHERE e.signNum = #{signNum}
	</select>
	<select id="refList" parameterType="Long" resultType="approval">
		SELECT f.empNo, s.empNo, t.empNo FROM e_document e
		LEFT OUTER JOIN f_approval f ON e.signNum = f.signNum
		LEFT OUTER JOIN s_approval s ON e.signNum = s.signNum
		LEFT OUTER JOIN t_approval t ON e.signNum = t.signNum
		WHERE e.signNum = #{signNum}
	</select>
</mapper>